<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citizen Assistant Chatbot</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="theme-toggle" style="position:absolute;left:20px;top:20px;">
                <button id="themeBtn" class="theme-btn" title="Karanlƒ±k/Aydƒ±nlƒ±k Tema">üåô</button>
            </div>
            <h1>ü§ñ Kurum ƒ∞√ßi Asistan</h1>
            <p>Kurumi√ßi akƒ±llƒ± asistanƒ±nƒ±z: Destek, bilgi ve i≈ülemler i√ßin size yardƒ±mcƒ± olur.</p>
            <button class="dashboard-btn" onclick="openDashboard()">üìä Dashboard</button>
        </div>

        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be added here dynamically -->
        </div>
        
        <div class="typing-indicator" id="typingIndicator">
            ü§ñ Citizen Assistant is typing...
        </div>
        
        <div class="report-upload-section">
            <form id="chatReportForm">
                <div class="upload-area">
                    <input type="file" name="file" id="chatReportFile" accept=".pdf,.doc,.docx" required hidden>
                    <label for="chatReportFile" class="upload-label">
                        <strong>Dosya Se√ßin</strong>
                        <span>veya s√ºr√ºkleyip bƒ±rakƒ±n</span>
                    </label>
                    <span id="fileName" class="file-name-display"></span>
                </div>
                <div class="upload-fields">
                    <input type="text" name="uploader" id="chatUploaderName" placeholder="Y√ºkleyen Adƒ±" required>
                    <button type="submit">Y√ºkle</button>
                </div>
                <span id="chatReportMsg"></span>
            </form>
        </div>
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <input type="text" class="chat-input" id="messageInput" 
                       placeholder="Type your message here..." 
                       onkeypress="handleKeyPress(event)">
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script src="/static/marked.min.js"></script>
    <script>
        let conversationStarted = false;

        async function initChat() {
            if (!conversationStarted) {
                const response = await fetch('/welcome');
                const data = await response.json();
                addMessage('bot', data.response);
                conversationStarted = true;
            }
        }

        function addMessage(sender, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            const avatar = sender === 'user' ? 'üë§' : 'ü§ñ';
            let renderedContent = content;
            // Belge se√ßimi i√ßin √∂zel kontrol
            if (sender === 'bot' && typeof content === 'string' && content.includes('Birden fazla belge bulundu. L√ºtfen a√ßƒ±klamak istediƒüiniz belgeyi se√ßin')) {
                // Belge se√ßeneklerini ayƒ±kla
                const lines = content.split('\n');
                const options = lines.filter(l => l.match(/^\d+: /));
                const info = lines[0];
                const example = lines.find(l => l.includes('√ñrnek:'));
                let btns = '';
                options.forEach(opt => {
                    const [id, ...rest] = opt.split(':');
                    const name = rest.join(':').trim();
                    btns += `<button class='select-report-btn' data-reportid='${id.trim()}' style='margin:4px 6px 4px 0;'>${name}</button>`;
                });
                renderedContent = `<div style='margin-bottom:8px;'>${info}</div><div>${btns}</div><div style='font-size:0.95em;color:#aaa;margin-top:6px;'>${example || ''}</div>`;
            } else if (sender === 'bot' && window.marked) {
                renderedContent = marked.parse(content);
            }
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${renderedContent}</div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Belge se√ßimi butonlarƒ±na event ekle
            if (sender === 'bot' && content && content.includes('Birden fazla belge bulundu. L√ºtfen a√ßƒ±klamak istediƒüiniz belgeyi se√ßin')) {
                document.querySelectorAll('.select-report-btn').forEach(btn => {
                    btn.onclick = function() {
                        const reportId = this.getAttribute('data-reportid');
                        const lastUserMsg = getLastUserMessage();
                        if (!lastUserMsg) return;
                        sendReportExplainRequest(reportId, lastUserMsg);
                    };
                });
            }
        }

        function getLastUserMessage() {
            // Son kullanƒ±cƒ± mesajƒ±nƒ± bulmak i√ßin chatMessages i√ßindeki son .message.user'ƒ± bul
            const messages = Array.from(document.querySelectorAll('.message.user .message-content'));
            if (messages.length === 0) return '';
            return messages[messages.length - 1].textContent;
        }

        async function sendReportExplainRequest(reportId, userMsg) {
            showTypingIndicator();
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: JSON.stringify({ tool: 'belge_sec_ve_acikla', report_id: reportId, sorgu: userMsg }) })
                });
                const data = await response.json();
                hideTypingIndicator();
                addMessage('bot', data.response);
            } catch (error) {
                hideTypingIndicator();
                addMessage('bot', 'Belge a√ßƒ±klama isteƒüi g√∂nderilirken hata olu≈ütu.');
            }
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').classList.add('show');
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').classList.remove('show');
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = input.value.trim();
            if (!message) return;

            // Info kutusunu gizle
            const infoBox = document.getElementById('infoBox');
            if (infoBox) infoBox.style.display = 'none';

            // Disable input and button
            input.disabled = true;
            sendBtn.disabled = true;

            // Add user message
            addMessage('user', message);
            input.value = '';

            // Show typing indicator
            showTypingIndicator();

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();

                // Hide typing indicator
                hideTypingIndicator();

                // Add bot response
                addMessage('bot', data.response);

            } catch (error) {
                hideTypingIndicator();
                addMessage('bot', 'Sorry, there was an error processing your message. Please try again.');
            }

            // Re-enable input and button
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function openDashboard() {
            window.open('/dashboard', '_blank');
        }

        // Initialize chat when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initChat();
            document.getElementById('messageInput').focus();
        });

        // Tema toggle ve localStorage
        document.addEventListener('DOMContentLoaded', function() {
            const themeBtn = document.getElementById('themeBtn');
            const body = document.body;

            function setDark(dark) {
                if (dark) {
                    body.classList.add('dark');
                    themeBtn.textContent = '‚òÄÔ∏è';
                    localStorage.setItem('theme', 'dark');
                } else {
                    body.classList.remove('dark');
                    themeBtn.textContent = 'üåô';
                    localStorage.setItem('theme', 'light');
                }
            }

            let isDark = localStorage.getItem('theme') === 'dark';
            setDark(isDark);

            themeBtn.onclick = function() {
                isDark = !isDark;
                setDark(isDark);
            };
        });

        window.hideInfoBox = function() {
            const infoBox = document.getElementById('infoBox'); // Sadece burada tanƒ±mlanƒ±r
            if(infoBox) infoBox.style.display = 'none';
        };

        // Dosya adƒ± g√∂sterme ve s√ºr√ºkle-bƒ±rak alanƒ± i√ßin JS
        const chatReportFile = document.getElementById('chatReportFile');
        const uploadArea = document.querySelector('.upload-area');
        const fileNameDisplay = document.getElementById('fileName');

        chatReportFile.addEventListener('change', () => {
            if (chatReportFile.files.length > 0) {
                fileNameDisplay.textContent = chatReportFile.files[0].name;
            } else {
                fileNameDisplay.textContent = '';
            }
        });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.add('highlight');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.remove('highlight');
            }, false);
        });

        uploadArea.addEventListener('drop', e => {
            chatReportFile.files = e.dataTransfer.files;
            fileNameDisplay.textContent = chatReportFile.files[0].name;
        }, false);

        document.getElementById('chatReportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('chatReportFile');
            const uploaderInput = document.getElementById('chatUploaderName');
            const msg = document.getElementById('chatReportMsg');
            if (!fileInput.files.length) {
                msg.textContent = 'L√ºtfen bir dosya se√ßin.';
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('uploader', uploaderInput.value);
            msg.textContent = 'Y√ºkleniyor...';
            try {
                const resp = await fetch('/upload_report', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                if (data.success) {
                    msg.textContent = 'Rapor ba≈üarƒ±yla y√ºklendi ve i≈ülendi.';
                    msg.style.color = '#10B981'; // Green for success
                    addMessage('bot', 'Belgeniz ba≈üarƒ±yla i≈ülendi. ≈ûimdi bu belge hakkƒ±nda sorularƒ±nƒ±zƒ± sorabilirsiniz.');
                    fileInput.value = '';
                    uploaderInput.value = '';
                } else {
                    msg.textContent = `Hata: ${data.message}`;
                    msg.style.color = '#EF4444'; // Red for error
                }
            } catch (err) {
                msg.textContent = 'Y√ºkleme sƒ±rasƒ±nda bir aƒü hatasƒ± olu≈ütu.';
                msg.style.color = '#EF4444';
            } finally {
                // Hide the message after a few seconds
                setTimeout(() => {
                    msg.textContent = '';
                }, 5000);
            }
        });
    </script>
</body>
</html>
