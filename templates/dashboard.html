<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorgu Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body class="dashboard-body">
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div>
                <h1>üìä Sorgu Dashboard'u</h1>
                <p>Sistem etkile≈üimlerinizin bir √∂zeti.</p>
            </div>
            <div class="header-actions">
                <button id="themeBtn" class="theme-btn" title="Karanlƒ±k/Aydƒ±nlƒ±k Tema">üåô</button>
                <a href="/tutorial" class="back-btn">üìñ √ñzellikler</a>
                <a href="/" class="back-btn">‚Üê Sohbete D√∂n</a>
            </div>
        </div>

        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-title">Toplam Rapor</div>
                <div class="stat-value" id="statTotalReports">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ƒ∞≈ülenen</div>
                <div class="stat-value" id="statProcessedReports">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Bekleyen</div>
                <div class="stat-value" id="statPendingReports">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">A√ßƒ±k Talepler</div>
                <div class="stat-value" id="statOpenTickets">-</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="grid-item">
                <h2>Destek Talepleri</h2>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Departman</th>
                                <th>A√ßƒ±klama</th>
                                <th>Durum</th>
                                <th>Olu≈üturulma</th>
                            </tr>
                        </thead>
                        <tbody id="supportTicketsTable">
                            <!-- JS ile doldurulacak -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="grid-item">
                <h2>Y√ºklenen Raporlar</h2>
                <div class="table-wrapper">
                    <button id="deleteAllBtn" class="delete-btn" style="margin-bottom:10px;">T√ºm√ºn√º Kalƒ±cƒ± Sil</button>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Dosya Adƒ±</th>
                                <th>Y√ºkleyen</th>
                                <th>Y√ºkleme Tarihi</th>
                                <th>ƒ∞ndir</th>
                                <th>Sil</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTable">
                            <!-- JS ile doldurulacak -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="grid-item grid-item-full-width">
                <h2>Sorgu Ge√ßmi≈üi</h2>
                 <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>T√ºr</th>
                                <th>Kullanƒ±cƒ± Mesajƒ±</th>
                                <th>Bot Cevabƒ±</th>
                                <th>Tarih</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable">
                            <!-- JS ile doldurulacak -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tema Y√∂netimi
        document.addEventListener('DOMContentLoaded', function() {
            const themeBtn = document.getElementById('themeBtn');
            const body = document.body;

            function setDark(dark) {
                if (dark) {
                    body.classList.add('dark');
                    themeBtn.textContent = '‚òÄÔ∏è';
                    localStorage.setItem('theme', 'dark');
                } else {
                    body.classList.remove('dark');
                    themeBtn.textContent = 'üåô';
                    localStorage.setItem('theme', 'light');
                }
            }

            let isDark = localStorage.getItem('theme') === 'dark';
            setDark(isDark);

            themeBtn.onclick = function() {
                isDark = !isDark;
                setDark(isDark);
            };
        });

        // Veri √áekme ve Tablolarƒ± Doldurma
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Destek Talepleri
                const supportResponse = await fetch('/api/support_tickets');
                const supportTickets = await supportResponse.json();
                const supportTableBody = document.getElementById('supportTicketsTable');
                supportTableBody.innerHTML = ''; // Clear existing
                if (supportTickets.length === 0) {
                     supportTableBody.innerHTML = '<tr><td colspan="5">G√∂sterilecek destek talebi yok.</td></tr>';
                } else {
                    supportTickets.forEach(ticket => {
                        const row = `<tr>
                            <td>${ticket.ticket_id.substring(0, 8)}</td>
                            <td>${ticket.department}</td>
                            <td class="description-cell">${ticket.description}</td>
                            <td><span class="status-badge status-${ticket.status.toLowerCase()}">${ticket.status}</span></td>
                            <td>${new Date(ticket.created_at).toLocaleString('tr-TR')}</td>
                        </tr>`;
                        supportTableBody.innerHTML += row;
                    });
                }

                // Y√ºklenen Raporlar
                const reportsResponse = await fetch('/reports');
                const reports = await reportsResponse.json();
                const reportsTableBody = document.getElementById('reportsTable');
                reportsTableBody.innerHTML = ''; // Clear existing
                if (reports.length === 0) {
                    reportsTableBody.innerHTML = '<tr><td colspan="4">Hen√ºz rapor y√ºklenmemi≈ü.</td></tr>';
                } else {
                    reports.forEach(report => {
                        const row = `<tr id="report-row-${report.id}">
                            <td>#${report.id}</td>
                            <td>${report.original_filename}</td>
                            <td>${report.uploader_name}</td>
                            <td>${new Date(report.created_at).toLocaleString('tr-TR')}</td>
                            <td><a href="/download_report/${report.stored_filename}" class="download-link">ƒ∞ndir</a></td>
                            <td><button onclick="deleteReport(${report.id})" class="delete-btn">Sil</button></td>
                        </tr>`;
                        reportsTableBody.innerHTML += row;
                    });
                }
                
                // Sorgu Ge√ßmi≈üi
                const historyResponse = await fetch('/api/history');
                const history = await historyResponse.json();
                const historyTableBody = document.getElementById('historyTable');
                historyTableBody.innerHTML = ''; // Clear existing
                // Dashboard istatistiklerini doldur
                try {
                    const dash = await fetch('/api/issues').then(r => r.json());
                    if (dash && dash.reports) {
                        document.getElementById('statTotalReports').textContent = dash.reports.total ?? '-';
                        document.getElementById('statProcessedReports').textContent = dash.reports.processed ?? '-';
                        document.getElementById('statPendingReports').textContent = dash.reports.unprocessed ?? '-';
                    }
                    if (dash && dash.tickets && dash.tickets.by_status) {
                        const open = dash.tickets.by_status.open || 0;
                        document.getElementById('statOpenTickets').textContent = open;
                    }
                } catch (e) {
                    // Sessizce ge√ß
                }
                 if (history.length === 0) {
                    historyTableBody.innerHTML = '<tr><td colspan="4">G√∂sterilecek sorgu ge√ßmi≈üi yok.</td></tr>';
                } else {
                    history.forEach(item => {
                        const row = `<tr>
                            <td>${item.type}</td>
                            <td class="description-cell">${item.user_message}</td>
                            <td class="description-cell">${item.bot_response}</td>
                            <td>${new Date(item.timestamp).toLocaleString('tr-TR')}</td>
                        </tr>`;
                        historyTableBody.innerHTML += row;
                    });
                }

            } catch (error) {
                console.error("Dashboard verileri y√ºklenirken hata olu≈ütu:", error);
                document.getElementById('reportsTable').innerHTML = '<tr><td colspan="4">Veriler y√ºklenemedi.</td></tr>';
                document.getElementById('supportTicketsTable').innerHTML = '<tr><td colspan="5">Veriler y√ºklenemedi.</td></tr>';
                document.getElementById('historyTable').innerHTML = '<tr><td colspan="4">Veriler y√ºklenemedi.</td></tr>';
            }
        });

        async function deleteReport(reportId) {
            if (!confirm("Bu raporu kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz?")) {
                return;
            }
            try {
                const response = await fetch(`/delete_report/${reportId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    // Remove the row from the table
                    const row = document.getElementById(`report-row-${reportId}`);
                    if (row) {
                        row.remove();
                    }
                    alert('Rapor ba≈üarƒ±yla silindi.');
                } else {
                    alert(`Hata: ${result.message}`);
                }
            } catch (error) {
                console.error("Rapor silinirken hata:", error);
                alert("Rapor silinirken bir aƒü hatasƒ± olu≈ütu.");
            }
        }

        // T√ºm√ºn√º Sil butonu
        document.addEventListener('DOMContentLoaded', function() {
            const deleteAllBtn = document.getElementById('deleteAllBtn');
            if (deleteAllBtn) {
                deleteAllBtn.onclick = async function() {
                    if (!confirm("T√ºm raporlarƒ± ve ili≈ükili verileri kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz?")) return;
                    try {
                        const response = await fetch('/delete_all_reports', { method: 'DELETE' });
                        const result = await response.json();
                        if (result.success) {
                            // Tablodan t√ºm satƒ±rlarƒ± kaldƒ±r
                            document.getElementById('reportsTable').innerHTML = '<tr><td colspan="4">Hen√ºz rapor y√ºklenmemi≈ü.</td></tr>';
                            alert('T√ºm raporlar ve ili≈ükili veriler ba≈üarƒ±yla silindi.');
                        } else {
                            alert('Hata: ' + result.message);
                        }
                    } catch (error) {
                        alert('Silme i≈ülemi sƒ±rasƒ±nda hata olu≈ütu.');
                    }
                }
            }
        });
    </script>
</body>
</html>
