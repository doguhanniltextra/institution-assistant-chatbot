<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citizen Assistant Chatbot</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="theme-toggle" style="position:absolute;left:20px;top:20px;">
                <button id="themeBtn" class="theme-btn" title="Karanlık/Aydınlık Tema">🌙</button>
            </div>
            <h1>🤖 Kurum İçi Asistan</h1>
            <p>Kurumiçi akıllı asistanınız: Destek, bilgi ve işlemler için size yardımcı olur.</p>
            <button class="dashboard-btn" onclick="openDashboard()">📊 Dashboard</button>
        </div>

        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be added here dynamically -->
        </div>
        
        <div class="typing-indicator" id="typingIndicator">
            🤖 Citizen Assistant is typing...
        </div>
        
        <div class="report-upload-section" style="padding:24px 32px 0 32px;">
            <h3 style="color:#4f46e5;font-size:1.1rem;margin-bottom:10px;">Rapor Yükle (Word/PDF)</h3>
            <form id="chatReportForm" enctype="multipart/form-data" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                <input type="file" name="file" id="chatReportFile" accept=".pdf,.doc,.docx" required style="padding:7px;"/>
                <input type="text" name="uploader" id="chatUploaderName" placeholder="Yükleyen Adı" required style="padding:7px;border-radius:8px;border:1px solid #e0e7ff;"/>
                <button type="submit" style="padding:8px 18px;border-radius:18px;background:linear-gradient(135deg,#667eea 0%,#4f46e5 100%);color:#fff;border:none;font-weight:500;cursor:pointer;">Yükle</button>
                <span id="chatReportMsg" style="margin-left:10px;font-size:1rem;"></span>
            </form>
        </div>
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <input type="text" class="chat-input" id="messageInput" 
                       placeholder="Type your message here..." 
                       onkeypress="handleKeyPress(event)">
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        let conversationStarted = false;

        async function initChat() {
            if (!conversationStarted) {
                const response = await fetch('/welcome');
                const data = await response.json();
                addMessage('bot', data.response);
                conversationStarted = true;
            }
        }

        function addMessage(sender, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = sender === 'user' ? '👤' : '🤖';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${content}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').classList.add('show');
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').classList.remove('show');
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = input.value.trim();
            if (!message) return;

            // Info kutusunu gizle
            const infoBox = document.getElementById('infoBox');
            if (infoBox) infoBox.style.display = 'none';

            // Disable input and button
            input.disabled = true;
            sendBtn.disabled = true;

            // Add user message
            addMessage('user', message);
            input.value = '';

            // Show typing indicator
            showTypingIndicator();

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();

                // Hide typing indicator
                hideTypingIndicator();

                // Add bot response
                addMessage('bot', data.response);

            } catch (error) {
                hideTypingIndicator();
                addMessage('bot', 'Sorry, there was an error processing your message. Please try again.');
            }

            // Re-enable input and button
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function openDashboard() {
            window.open('/dashboard', '_blank');
        }

        // Initialize chat when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initChat();
            document.getElementById('messageInput').focus();
        });

        // Tema toggle ve localStorage
        document.addEventListener('DOMContentLoaded', function() {
            const themeBtn = document.getElementById('themeBtn');
            const body = document.body;
            const chatContainer = document.querySelector('.chat-container');
            const chatHeader = document.querySelector('.chat-header');
            const chatMessages = document.getElementById('chatMessages');
            const chatInputContainer = document.querySelector('.chat-input-container');
            const infoBox = document.getElementById('infoBox');
            const chatInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const typingIndicator = document.getElementById('typingIndicator');
            function setDark(dark) {
                if(dark) {
                    body.classList.add('dark');
                    chatContainer.classList.add('dark');
                    chatHeader.classList.add('dark');
                    chatMessages.classList.add('dark');
                    chatInputContainer.classList.add('dark');
                    infoBox.classList.add('dark');
                    chatInput.classList.add('dark');
                    sendBtn.classList.add('dark');
                    document.querySelectorAll('.message-content').forEach(e=>e.classList.add('dark'));
                    document.querySelectorAll('.message-avatar').forEach(e=>e.classList.add('dark'));
                    typingIndicator.classList.add('dark');
                    themeBtn.textContent = '☀️';
                    localStorage.setItem('theme', 'dark');
                } else {
                    body.classList.remove('dark');
                    chatContainer.classList.remove('dark');
                    chatHeader.classList.remove('dark');
                    chatMessages.classList.remove('dark');
                    chatInputContainer.classList.remove('dark');
                    infoBox.classList.remove('dark');
                    chatInput.classList.remove('dark');
                    sendBtn.classList.remove('dark');
                    document.querySelectorAll('.message-content').forEach(e=>e.classList.remove('dark'));
                    document.querySelectorAll('.message-avatar').forEach(e=>e.classList.remove('dark'));
                    typingIndicator.classList.remove('dark');
                    themeBtn.textContent = '🌙';
                    localStorage.setItem('theme', 'light');
                }
            }
            let dark = localStorage.getItem('theme') === 'dark';
            setDark(dark);
            themeBtn.onclick = function() {
                dark = !dark;
                setDark(dark);
            };

            // Sohbet başlayınca infoBox'ı gizle
            window.hideInfoBox = function() {
                if(infoBox) infoBox.style.display = 'none';
            };
        });

        document.getElementById('chatReportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('chatReportFile');
            const uploaderInput = document.getElementById('chatUploaderName');
            const msg = document.getElementById('chatReportMsg');
            if (!fileInput.files.length) {
                msg.textContent = 'Lütfen bir dosya seçin.';
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('uploader', uploaderInput.value);
            msg.textContent = 'Yükleniyor...';
            try {
                const resp = await fetch('/upload_report', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                if (data.success) {
                    msg.textContent = 'Rapor başarıyla yüklendi!';
                    fileInput.value = '';
                    uploaderInput.value = '';
                } else {
                    msg.textContent = data.message;
                }
            } catch (err) {
                msg.textContent = 'Yükleme sırasında hata oluştu.';
            }
        });
    </script>
</body>
</html>
